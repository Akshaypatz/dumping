<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Payment Form</title>
    <link rel="stylesheet" href="styles.css">
</head>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f6f9fc;
        font-size: 16px;
        line-height: 1.5;
        padding: 20px 0;
    }

    .container {
        background-color: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        width: 100%;
        max-width: 500px;
    }

    /* Payment Details */
    .payment-details {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e6e6e6;
    }
    
    .merchant-name {
        font-size: 18px;
        font-weight: 600;
        color: #32325d;
        margin-bottom: 8px;
    }
    
    .payment-amount {
        font-size: 24px;
        font-weight: 700;
        color: #32325d;
    }
    
    .payment-currency {
        font-size: 16px;
        color: #6b7280;
        margin-left: 4px;
    }
    
    /* Footer with payment networks */
    .payment-footer {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #e6e6e6;
        text-align: center;
    }
    
    .payment-networks {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 8px;
    }
    
    .network-icon {
        width: 32px;
        height: 20px;
        opacity: 0.6;
    }
    
    .security-text {
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
    }

    /* Rest of your existing styles remain the same */
    .p-Grid {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -8px;
    }

    .p-GridCell {
        padding: 0 8px;
        box-sizing: border-box;
    }

    .p-GridCell--12 {
        width: 100%;
    }

    @media (min-width: 768px) {
        .p-GridCell--sm6 {
            width: 50%;
        }
    }

    .p-Field {
        margin-bottom: 16px;
    }

    .p-FieldLabel {
        font-weight: 500;
        font-size: 14px;
        display: block;
        margin-bottom: 8px;
        color: #424770;
    }

    .p-Select, .p-Input {
        position: relative;
    }

    .p-Select-select, .p-Input-input {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-color: white;
        border: 1px solid #e4e4e4;
        border-radius: 4px;
        padding: 10px 12px;
        width: 100%;
        font-size: 16px;
        color: #32325d;
        box-sizing: border-box;
        transition: background 0.15s ease, border 0.15s ease, box-shadow 0.15s ease, color 0.15s ease;
        box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.03), 0px 3px 6px rgba(0, 0, 0, 0.02);
    }

    .p-Select-select:focus, .p-Input-input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, .25);
    }

    .p-InputIcon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }

    .p-InputIcon svg {
        width: 0.8em;
        height: 0.8em;
    }

    :root {
        --colorIconChevronDown: #32325d;
    }

    .u-mt-grid {
        margin-top: 16px;
    }

    .error-message {
        color: #df1b41;
        font-size: 15px;
        margin-top: 4px;
        display: none;
    }
    .error-message.visible {
        display: block;
    }

    input.error {
        color: red;
        border-color: #df1b41;
        box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.03), 0px 3px 6px rgba(0, 0, 0, 0.02), 0 0 0 1px #df1b41;
    }

    .hidden {
        display: none;
    }

    .full-width {
        width: 100%;
    }

    .form-row {
        margin-bottom: 16px;
    }

    .form-row-inline {
        display: flex;
        justify-content: space-between;
    }

    .col-50 {
        width: 48%;
    }

    label {
        font-weight: 500;
        font-size: 14px;
        display: block;
        margin-bottom: 8px;
        color: #424770;
    }

    .input-container {
        position: relative;
    }

    input {
        background-color: white;
        border: 1px solid #e4e4e4;
        border-radius: 4px;
        padding: 10px 12px;
        width: 100%;
        font-size: 16px;
        color: #32325d;
        box-sizing: border-box;
        transition: background 0.15s ease, border 0.15s ease, box-shadow 0.15s ease, color 0.15s ease;
        box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.03), 0px 3px 6px rgba(0, 0, 0, 0.02);
    }

    input:focus {
        outline: none !important;
        border-color: #80bdff !important;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, .25) !important;
    }

    input::placeholder {
        color: #aab7c4;
    }

    input.error {
        color: red;
        border-color: #df1b41;
        box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.03), 0px 3px 6px rgba(0, 0, 0, 0.02), 0 0 0 1px #df1b41;
    }

    .card-brand-icons {
        position: absolute;
        right: 10px;
        top: 10px;
        display: block;
    }

    .card-brand-icon {
        width: 24px;
        height: 16px;
        object-fit: contain;
        transition: width 0.4s ease-in-out;
        opacity: 1;
    }

    .card-brand-icon:not(.active) {
        width: 0;
        opacity: 0;
        position: absolute;
        right: 0;
        transition: width 1s ease-in-out;
    }

    .card-brand-icon.dynamic {
        transition: opacity 0s;
    }

    .card-brand-icon.dynamic:not(.active) {
        opacity: 0;
        width: 24px;
        position: absolute;
        right: 0;
    }

    .invalid-card-icon {
        display: none;
        fill: red;
    }

    .invalid-card-icon.active {
        display: block;
    }

    .cvc-wrapper {
        position: relative;
    }

    .cvc-icons {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
    }

    .cvc-icon {
        width: 24px;
        height: 24px;
        display: none;
    }

    .cvc-icon.active {
        display: block;
    }

    #payBtn {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 12px 16px;
        font-size: 16px;
        font-weight: 600;
        color: white;
        background-color: #635bff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
        overflow: hidden;
        height: 44px;
    }

    .lock-icon {
        display: none;
    }

    #payBtn:hover:not(:disabled) {
        background-color: #5851e6;
    }

    #payBtn:focus:not(:disabled) {
        outline: none;
        box-shadow: 0 0 0 2px rgba(99,91,255,0.2);
    }

    #payBtn:active:not(:disabled) {
        background-color: #4f47d8;
    }

    #payBtn:disabled {
        background-color: #e0e0e0;
        color: #a0a0a0;
        cursor: not-allowed;
    }
    #payBtn.SubmitButton--disabled {
        background-color: #e0e0e0;
        color: #a0a0a0;
    }

    .SubmitButton--disabled .SubmitButton-IconContainer {
        display: none;
    }

    .SubmitButton-IconContainer {
        position: absolute;
        right: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
    }

    .Icon {
        width: 100%;
        height: 100%;
    }

    .Icon svg {
        width: 100%;
        height: 100%;
    }

    @keyframes rotate {
        100% {
            transform: rotate(360deg);
        }
    }

    .Icon--loading svg {
        animation: rotate 1s linear infinite;
    }

    .Icon--loading circle {
        stroke-dasharray: 60;
        stroke-dashoffset: 20;
        stroke-linecap: round;
    }

    .SubmitButton--success {
        background-color: #24b47e !important;
        transition: background-color 0.3s ease;
    }

    .SubmitButton--success span {
        display: none;
    }

    .SubmitButton--success .SubmitButton-IconContainer {
        right: auto;
        left: 50%;
        transform: translateX(-50%);
        width: 28.8px;
        height: 28.8px;
    }

    .SubmitButton-CheckmarkIcon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }

    .SubmitButton-CheckmarkIcon svg path.checkmark {
        stroke-dasharray: 50;
        stroke-dashoffset: 50;
        animation: checkmark 0.3s ease-in-out forwards;
    }

    @keyframes checkmark {
        0% {
            stroke-dashoffset: 50;
        }
        100% {
            stroke-dashoffset: 0;
        }
    }

    .error-message {
        color: #df1b41;
        font-size: 15px;
        margin-top: 4px;
        display: none;
        line-height: 1.3;
        word-wrap: break-word;
    }

    .input-container {
        position: relative;
        margin-bottom: 5px;
    }

    .product-summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #fafbff;
        border: 1px solid #e4e4e4;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    }

    .product-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 16px;
    }

    .product-info {
        flex: 1;
        margin-right: 16px;
    }

    .product-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 4px;
        color: #32325d;
    }

    .product-desc {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
    }

    .product-price {
        font-size: 20px;
        font-weight: 700;
        color: #24b47e;
        white-space: nowrap;
    }
</style>

<body>
    <div class="container">
        <!-- Payment Details -->
        <div class="payment-details">
            <div class="merchant-name">Merchant Name Inc.</div>
            <div class="payment-amount">₹4499.00<span class="payment-currency">INR</span></div>
        </div>
        
        <form id="payment-form">
            <!-- Card Number Field -->
            <div class="form-row">
                <label for="card-number">Card number</label>
                <div class="input-container">
                    <input id="card-number" type="text" placeholder="1234 1234 1234 1234" value="4591 5000 0000 0055" required>
                    <div class="card-brand-icons">
                        <img src="https://js.stripe.com/v3/fingerprinted/img/visa-729c05c240c4bdb47b03ac81d9945bfe.svg" class="card-brand-icon card-visa" alt="Visa">
                        <img src="https://js.stripe.com/v3/fingerprinted/img/mastercard-4d8844094130711885b5e41b28c9848f.svg" class="card-brand-icon card-mastercard" alt="Mastercard">
                        <img src="https://js.stripe.com/v3/fingerprinted/img/amex-a49b82f46c5cd6a96a6e418a6ca1717c.svg" class="card-brand-icon card-amex" alt="American Express">
                        <img src="https://js.stripe.com/v3/fingerprinted/img/discover-ac52cd46f89fa40a29a0bfb954e33173.svg" class="card-brand-icon card-discover dynamic" alt="Discover">
                        <img src="https://js.stripe.com/v3/fingerprinted/img/jcb-271fd06e6e7a2c52692ffa91a95fb64f.svg" class="card-brand-icon card-jcb dynamic" alt="JCB">
                        <img src="https://js.stripe.com/v3/fingerprinted/img/diners-fbcbd3360f8e3f629cdaa80e93abdb8b.svg" class="card-brand-icon card-diners card-dinersclub dynamic" alt="Diners Club">
                        <svg class="invalid-card-icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path opacity=".4" fill-rule="evenodd" clip-rule="evenodd" d="M15.337 4A5.5 5.5 0 1023 11.663V18a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h12.337zm6.707.293c.239.202.46.424.662.663a2.01 2.01 0 00-.662-.663zM3 9a1 1 0 011-1h5a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V9z"></path>
                            <path opacity=".6" fill-rule="evenodd" clip-rule="evenodd" d="M4 15a1 1 0 100 2h1.5a1 1 0 100-2H4zm4.8 0a1 1 0 100 2h1.5a1 1 0 100-2H8.8zm3.8 1a1 1 0 011-1h1.5a1 1 0 110 2h-1.5a1 1 0 01-1-1zm5.9-1a1 1 0 100 2H20a1 1 0 100-2h-1.5z"></path>
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M18.5 14a5.5 5.5 0 110-11 5.5 5.5 0 010 11zm0-1.719a1.031 1.031 0 100-2.062 1.031 1.031 0 000 2.062zm0-7.906a.687.687 0 00-.688.688V8.5a.687.687 0 101.375 0V5.062a.687.687 0 00-.687-.687z"></path>
                        </svg>
                    </div>
                </div>
                <div class="error-message" id="card-number-error"></div>
            </div>

            <!-- Expiry Date and CVC Fields -->
            <div class="form-row form-row-inline">
                <div class="col-50">
                    <label for="card-expiry">Expiration Date</label>
                    <input id="card-expiry" type="text" placeholder="MM / YY" value="12/29" required>
                    <div class="error-message" id="card-expiry-error"></div>
                </div>
                <div class="col-50">
                    <label for="card-cvc">Security Code</label>
                    <div class="cvc-wrapper">
                        <input id="card-cvc" type="text" placeholder="CVC" value="123" required>
                        <div class="cvc-icons">
                            <svg class="cvc-icon cvc-3digit active" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#A0A0A0" role="img" aria-labelledby="cvcDesc">
                                <path opacity=".2" fill-rule="evenodd" clip-rule="evenodd" d="M15.337 4A5.493 5.493 0 0013 8.5c0 1.33.472 2.55 1.257 3.5H4a1 1 0 00-1 1v1a1 1 0 001 1h16a1 1 0 001-1v-.6a5.526 5.526 0 002-1.737V18a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2h12.337zm6.707-.707c.239.202.46.424.662.663a2.01 2.01 0 00-.662-.663z"></path>
                                <path opacity=".4" fill-rule="evenodd" clip-rule="evenodd" d="M13.6 6a5.477 5.477 0 00-.578 3H1V6h12.6z"></path>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.5 14a5.5 5.5 0 110-11 5.5 5.5 0 010 11zm-2.184-7.779h-.621l-1.516.77v.786l1.202-.628v3.63h.943V6.22h-.008zm1.807.629c.448 0 .762.251.762.613 0 .393-.37.668-.904.668h-.235v.668h.283c.565 0 .95.282.95.691 0 .393-.377.66-.911.66-.393 0-.786-.126-1.194-.37v.786c.44.189.88.291 1.312.291 1.029 0 1.736-.526 1.736-1.288 0-.535-.33-.967-.88-1.14.472-.157.778-.573.778-1.045 0-.738-.652-1.241-1.595-1.241a3.143 3.143 0 00-1.234.267v.77c.378-.212.763-.33 1.132-.33zm3.394 1.713c.574 0 .974.338.974.778 0 .463-.4.785-.974.785-.346 0-.707-.11-1.076-.337v.809c.385.173.778.26 1.163.26.204 0 .392-.032.573-.08a4.313 4.313 0 00.644-2.262l-.015-.33a1.807 1.807 0 00-.967-.252 3 3 0 00-.448.032V8.944h1.132a4.423 4.423 0 00-.362-.723h-1.587v2.475c.315-.078.629-.133.943-.133z"></path>
                            </svg>
                            <svg class="cvc-icon cvc-4digit" width="24" height="24" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#A0A0A0" role="img" aria-labelledby="cvcDesc">
                                <path opacity=".2" fill-rule="evenodd" clip-rule="evenodd" d="M1 6a2 2 0 012-2h18a2 2 0 012 2v1.337a5.5 5.5 0 100 6.326V18a2 2 0 01-2 2H3a2 2 0 01-2-2V6zm2 3a1 1 0 011-1h5a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V9z"></path>
                                <path opacity=".4" fill-rule="evenodd" clip-rule="evenodd" d="M3 16a1 1 0 011-1h1.5a1 1 0 110 2H4a1 1 0 01-1-1zm5 0a1 1 0 011-1h6a1 1 0 110 2H9a1 1 0 01-1-1zm10.5-1a1 1 0 100 2H20a1 1 0 100-2h-1.5z"></path>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.5 16a5.5 5.5 0 110-11 5.5 5.5 0 010 11zm-2.184-7.779h-.621l-1.516.77v.786l1.202-.628v3.63h.943V8.22h-.008zm1.807.629c.448 0 .762.251.762.613 0 .393-.37.668-.904.668h-.235v.668h.283c.565 0 .95.282.95.691 0 .393-.377.66-.911.66-.393 0-.786-.126-1.194-.37v.786c.44.189.88.291 1.312.291 1.029 0 1.736-.526 1.736-1.288 0-.535-.33-.967-.88-1.14.472-.157.778-.573.778-1.045 0-.738-.652-1.241-1.595-1.241a3.143 3.143 0 00-1.234.267v.77c.378-.212.763-.33 1.132-.33zm3.394 1.713c.574 0 .974.338.974.778 0 .463-.4.785-.974.785-.346 0-.707-.11-1.076-.337v.809c.385.173.778.26 1.163.26.204 0 .392-.032.573-.08a4.313 4.313 0 00.644-2.262l-.015-.33a1.807 1.807 0 00-.967-.252 3 3 0 00-.448.032V8.944h1.132a4.423 4.423 0 00-.362-.723h-1.587v2.475c.315-.078.629-.133.943-.133z"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="error-message" id="card-cvc-error"></div>
                </div>
            </div>

            <div class="form-row">
                <label for="card-name">Card Holder Name</label>
                <div class="input-container">
                    <input id="card-name" type="text" placeholder="Akshay Patel" value="Akshay Patel" required>
                </div>
            </div>

            <!-- Billing Information Section -->
            <div class="p-Grid p-BillingAddressForm u-mt-grid">
                <!-- ZIP / Postal Code Field -->
                <div class="p-GridCell p-GridCell--12 p-GridCell--sm6 hidden">
                    <div class="p-Field" field="postalCode">
                        <label class="p-FieldLabel" for="zip-code-input" id="zip-code-input-label">ZIP / Postal code</label>
                        <div class="p-Input">
                            <input type="text" id="zip-code-input" class="p-Input-input" required>
                        </div>
                        <div id="zip-code-error" class="error-message" role="alert"></div>
                    </div>
                </div>
            </div>

            <!-- Pay Button -->
            <div class="form-row">
                <button id="payBtn" type="submit">
                    <span>Pay ₹4499.00</span>
                    <div class="SubmitButton-IconContainer">
                        <svg class="lock-icon" viewBox="0 0 11.264 11.264" xmlns="http://www.w3.org/2000/svg" focusable="false">
                            <path d="M2.112 4.928V3.52a3.52 3.52 0 0 1 7.04 0v1.408h.352a0.704 0.704 0 0 1 0.704 0.704v4.224a1.408 1.408 0 0 1-1.408 1.408H2.464a1.408 1.408 0 0 1-1.408-1.408V5.632a0.704 0.704 0 0 1 0.704-0.704zm3.52 1.76a0.704 0.704 0 0 0-0.704 0.704v1.408a0.704 0.704 0 0 0 1.408 0V7.392a0.704 0.704 0 0 0-0.704-0.704zM7.744 4.928V3.52a2.112 2.112 0 1 0-4.224 0v1.408z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </div>
                </button>
            </div>
        </form>

        <!-- Payment Networks Footer -->
        <div class="payment-footer">
            <div class="security-text">Secure payment with</div>
            <div class="payment-networks">
                <img src="https://js.stripe.com/v3/fingerprinted/img/visa-729c05c240c4bdb47b03ac81d9945bfe.svg" class="network-icon" alt="Visa">
                <img src="https://js.stripe.com/v3/fingerprinted/img/mastercard-4d8844094130711885b5e41b28c9848f.svg" class="network-icon" alt="Mastercard">
                <img src="https://js.stripe.com/v3/fingerprinted/img/amex-a49b82f46c5cd6a96a6e418a6ca1717c.svg" class="network-icon" alt="American Express">
                <img src="https://js.stripe.com/v3/fingerprinted/img/rupay-628f674c4c2c8e5f2b6359d4311a2b7a.svg" class="network-icon" alt="RuPay">
            </div>
        </div>

        <div id="dccNotice" class="notice"></div>
    </div>

    <script src="dcc-sdk_final_sdk_DCC3.js"></script>
    

    <script type="module">
import {
  CompactSign, CompactEncrypt,
  compactVerify, compactDecrypt, importJWK
} from 'https://cdn.jsdelivr.net/npm/jose@5.6.0/+esm';

function toBase64Url(b64) {
  return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// ---------- Shared Keys ----------
const hmacSecret = "U1lNTUpPU0VFTkNSREVDUioqKioqKioqKioqKioqKio="; // HMAC for signing
const aesSecret  = "U1lNTUpPU0VFTkNSREVDUlNZTU1KT1NFRU5DUkRFQ1I="; // AES for encryption

const hmacKey = await importJWK({ kty: 'oct', k: toBase64Url(hmacSecret), alg: 'HS256' }, 'HS256');
const aesKey  = await importJWK({ kty: 'oct', k: toBase64Url(aesSecret),  alg: 'A256GCM' }, 'A256GCM');

const notice = document.getElementById('dccNotice');

document.getElementById('payBtn').addEventListener('click', async () => {
  notice.style.display='none';

  const cardInfo = {
    number: document.getElementById('card-number').value,
    expiry: document.getElementById('card-expiry').value,
    cvv: document.getElementById('card-cvc').value,
    name: document.getElementById('card-name').value
  };

  try {
    const requestPayload = {
      mercId: "MERC123456",
      orderId: 'ORD' + Math.floor(Math.random()*1_000_000),
      currency: "356",
      amount: "50000.00",
      card: {
        number: cardInfo.number,
        expiry_month: cardInfo.expiry.split('/')[0],
        expiry_year: "20" + cardInfo.expiry.split('/')[1],
        cvv: cardInfo.cvv,
        holder_name: cardInfo.name
      }
    };

    // ---------- Encrypt (JWE) ----------
    const jwe = await new CompactEncrypt(new TextEncoder().encode(JSON.stringify(requestPayload)))
      .setProtectedHeader({ alg: 'dir', enc: 'A256GCM', kid: 'AES_DIR', clientid: 'SYMM1230' })
      .encrypt(aesKey);

    // ---------- Sign (JWS over JWE) ----------
    const jws = await new CompactSign(new TextEncoder().encode(jwe))
      .setProtectedHeader({ alg: 'HS256', kid: 'HMAC', clientid: 'SYMM1230' })
      .sign(hmacKey);

    console.log('Encrypted & Signed Request (JWS):', jws);

    // ---- Send to backend ----
    const response = await fetch("http://localhost:8889/payments/ve1_2/dcc/inquiry/create", {
      method: "POST",
      headers: { "Content-Type": "application/jose",
                 "Accept": "application/jose",
                 "BD-Traceid": "BDAKSDCCCREATE"+Math.floor(Math.random()*1_000_00),
                 "BD-Timestamp":"1758467026508" 
                },
      body: jws
    });

    if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const responseJws = await response.text();
    console.log('Encrypted & Signed Response (JWS):', responseJws);

    // ---------- Verify signature ----------
    const { payload: verifiedCiphertext } = await compactVerify(responseJws, hmacKey);

    // ---------- Decrypt ----------
    const { plaintext } = await compactDecrypt(new TextDecoder().decode(verifiedCiphertext), aesKey);

    const jsonResponse = JSON.parse(new TextDecoder().decode(plaintext));
    console.log('Decrypted Response:', jsonResponse);

    if(jsonResponse.status === 'RATES_RECEIVED'){
      console.log(`Exchange Rate: ${jsonResponse.dcc.exchangeRate}`);
      console.log(`Cardholder Currency Amount: ${jsonResponse.dcc.cardholderCurrencyAmount}`);
    } else {
      notice.textContent = "DCC not enabled or no rates received.";
      notice.style.display = "block";
    }

    const sdk = new DCCSDK({
            apiBase: 'http://localhost:8889',
            onError: err => console.log('SDK onError callback:', err)
          });

          const authorization = jsonResponse.links?.[0]?.headers?.authorization;
          console.log(authorization);
          console.log(jsonResponse.mercid);
          console.log(jsonResponse.dcc.dccOrderid);
        
          try {
            const result = await sdk.initiateDCCFlow(jsonResponse.mercid,jsonResponse.dcc.dccOrderid, authorization);
            // console.log(`Merchant received:
            //   Currency=${result.selectedCurrency},
            //   Amount=${result.selectedAmount},
            //   International=${result.internationalCurrencySelected}`);

            console.log(result);
            // Merchant continues with createTransaction API here
          } catch(e){
            // --- Show user friendly message for rate expiry ---
            if(e.code === "DCC_RATE_EXPIRED"){
              notice.textContent = "The DCC rate has expired. Please re-enter your card details and try again.";
              notice.style.display = "block";
            } else if(e.code === "USER_CANCELLED"){
              notice.textContent = "You cancelled the currency selection. You may try again.";
              notice.style.display = "block";
            } else {
              notice.textContent = "An unexpected error occurred. Please try again.";
              notice.style.display = "block";
            }
            console.log("SDK rejected:", e);
          }


  } catch(e){
    notice.textContent = "An unexpected error occurred. Please try again.";
    notice.style.display = "block";
    console.error("Error:", e);
  }
    
});



</script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="scripts.js"></script>
</body>
</html>